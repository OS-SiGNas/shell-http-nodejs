import{argv,exit,platform,arch}from"node:process";import{promisify,styleText}from"node:util";import{readFile}from"node:fs/promises";import{exec}from"node:child_process";import{extname}from"node:path";import{Server}from"node:http";const HttpShell=class{static init=()=>{const e=(e,t)=>(this.#e(e,t),"GET"!==e.method?t.writeHead(404).end():e.url?.includes("/status")?t.writeHead(204).end():e.url?.includes("/info")?this.#t(e,t):e.url?.includes("/sh")?this.#i(e,t):e.url?.includes("/file")?this.#n(e,t):t.writeHead(404).end()),t=void 0===(i=argv[2])||isNaN(+i)?0:+i;var i;try{const{port:i}=(new Server).on("request",e).listen(t,(()=>console.info(styleText(["bold","green"],`\n\n[*] Server: http://127.0.0.1:${i}`)))).address();process.on("SIGINT",this.#o),process.on("SIGTERM",this.#o)}catch(e){console.trace(e),this.#o()}};static#e=({method:e,url:t},i)=>{const n=Date.now(),o=styleText(["bgWhite","bold","black"],`[${e}]`),r=styleText(["blue","bold"],`${t}`);i.on("finish",(()=>{const e=Date.now()-n;console.log(`${o} - ${r} - ${i.statusCode} - ${e}ms`)}))};static#t=(e,t)=>(t.writeHead(200,this.#r("plain")),t.write(`${platform} ${arch}`),t.end());static#i=async(e,t)=>{const i=this.#s(e.url);if(void 0===i.command)return t.writeHead(400).end();try{const{stderr:e,stdout:n}=await promisify(exec)(i.command);if(0!==e.length)throw new Error(e);return t.writeHead(200,this.#r("plain")).write(n),t.end()}catch(e){return t.writeHead(400,this.#r("json")).write(JSON.stringify(e)),t.end()}};static#n=async(e,t)=>{const i=this.#s(e.url);if(void 0===i.name)return t.writeHead(400).end();try{const e=this.#r(extname(i.name));return t.writeHead(200,e).write(await readFile(i.name)),t.end()}catch(e){return console.trace(e),t.writeHead(400).write(e),t.end()}};static#s=e=>{const[t,i]=e.split("?");if(void 0===i)return{query:{}};const n=new URL("https://example.com"+e),o=new URLSearchParams(n.search);return Object.fromEntries(o.entries())};static#r=e=>{let t;return t=e.includes(".")?this.#a[e.split(".").pop()]:this.#a[e],void 0!==t?{"Content-Type":t}:void 0};static#a={pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",zip:"application/zip",pdf:"application/pdf",json:"application/json",xml:"application/xml",plain:"text/plain",txt:"text/plain",html:"text/html",css:"text/css",png:"image/png",jpg:"image/jpg",jpeg:"image/jpeg",gif:"image/gif",svg:"image/svg+xml",webp:"image/webp",mp3:"audio/mp3",wav:"audio/wav",ogg:"audio/ogg",mp4:"video/mp4",mkv:"video/mkv",webm:"video/webm",avi:"video/x-msvideo"};static#o=()=>{console.info(styleText(["bold","red"],"\n\n[*] Stopping server.")),exit(1)}};HttpShell.init();